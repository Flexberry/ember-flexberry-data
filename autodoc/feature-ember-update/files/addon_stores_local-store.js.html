<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>addon/stores/local-store.js - Flexberry Documentation</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
	    <img alt="Flexberry Documentation" src="../assets/css/logo.png" style="max-height: 65%;" title="Flexberry Documentation">
            Flexberry Documentation
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>master</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/AdapterMixin", "classes/ApplicationInitializer", "classes/Base", "classes/BaseAdapter", "classes/BaseBuilder", "classes/BasePredicate", "classes/Builder", "classes/ComplexPredicate", "classes/Condition", "classes/CopyableMixin", "classes/DatePredicate", "classes/DecimalTransform", "classes/DexieService", "classes/FileTransform", "classes/FilterOperator", "classes/FlexberryEnumTransform", "classes/GlobalsService", "classes/GuidTransform", "classes/IndexedDBAdapter", "classes/Information", "classes/JsAdapter", "classes/LocalStore", "classes/Model", "classes/ModelMixin", "classes/OData", "classes/OData.OnlineStore", "classes/ODataAdapter", "classes/Offline", "classes/OrderByClause", "classes/Projection", "classes/Query.Condition", "classes/Query.DetailPredicate", "classes/Query.FilterOperator", "classes/Query.GeographyPredicate", "classes/Query.GeometryPredicate", "classes/Query.IsOfPredicate", "classes/Query.NotPredicate", "classes/Query.OrderByClause", "classes/QueryObject", "classes/SimplePredicate", "classes/Store", "classes/StoreMixin", "classes/StringPredicate", "classes/Syncer", "modules/ember-flexberry", "modules/ember-flexberry-data"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
	        <h3>APIs</h3>
	        <div id="sidebar">
	            <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
	                <li class="active"><a href="#classes" data-toggle="tab">Classes</a></li>
	                <li><a href="#modules" data-toggle="tab">Modules</a></li>
	            </ul>
	    
	            <div id="api-tabview-filter">
	                <input type="search" placeholder="Type to filter APIs">
	            </div>
	    
	            <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
	                <div class="tab-pane active" id="classes">
	                    <ul id="api-classes" class="nav nav-list">
	                            <li><a href="../classes/AdapterMixin.html">AdapterMixin</a></li>
	                            <li><a href="../classes/ApplicationInitializer.html">ApplicationInitializer</a></li>
	                            <li><a href="../classes/Base.html">Base</a></li>
	                            <li><a href="../classes/BaseAdapter.html">BaseAdapter</a></li>
	                            <li><a href="../classes/BaseBuilder.html">BaseBuilder</a></li>
	                            <li><a href="../classes/BasePredicate.html">BasePredicate</a></li>
	                            <li><a href="../classes/Builder.html">Builder</a></li>
	                            <li><a href="../classes/ComplexPredicate.html">ComplexPredicate</a></li>
	                            <li><a href="../classes/Condition.html">Condition</a></li>
	                            <li><a href="../classes/CopyableMixin.html">CopyableMixin</a></li>
	                            <li><a href="../classes/DatePredicate.html">DatePredicate</a></li>
	                            <li><a href="../classes/DecimalTransform.html">DecimalTransform</a></li>
	                            <li><a href="../classes/DexieService.html">DexieService</a></li>
	                            <li><a href="../classes/FileTransform.html">FileTransform</a></li>
	                            <li><a href="../classes/FilterOperator.html">FilterOperator</a></li>
	                            <li><a href="../classes/FlexberryEnumTransform.html">FlexberryEnumTransform</a></li>
	                            <li><a href="../classes/GlobalsService.html">GlobalsService</a></li>
	                            <li><a href="../classes/GuidTransform.html">GuidTransform</a></li>
	                            <li><a href="../classes/IndexedDBAdapter.html">IndexedDBAdapter</a></li>
	                            <li><a href="../classes/Information.html">Information</a></li>
	                            <li><a href="../classes/JsAdapter.html">JsAdapter</a></li>
	                            <li><a href="../classes/Model.html">Model</a></li>
	                            <li><a href="../classes/ModelMixin.html">ModelMixin</a></li>
	                            <li><a href="../classes/OData.html">OData</a></li>
	                            <li><a href="../classes/ODataAdapter.html">ODataAdapter</a></li>
	                            <li><a href="../classes/Offline.html">Offline</a></li>
	                            <li><a href="../classes/OrderByClause.html">OrderByClause</a></li>
	                            <li><a href="../classes/Projection.html">Projection</a></li>
	                            <li><a href="../classes/Query.Condition.html">Query.Condition</a></li>
	                            <li><a href="../classes/Query.DetailPredicate.html">Query.DetailPredicate</a></li>
	                            <li><a href="../classes/Query.FilterOperator.html">Query.FilterOperator</a></li>
	                            <li><a href="../classes/Query.GeographyPredicate.html">Query.GeographyPredicate</a></li>
	                            <li><a href="../classes/Query.GeometryPredicate.html">Query.GeometryPredicate</a></li>
	                            <li><a href="../classes/Query.IsOfPredicate.html">Query.IsOfPredicate</a></li>
	                            <li><a href="../classes/Query.NotPredicate.html">Query.NotPredicate</a></li>
	                            <li><a href="../classes/Query.OrderByClause.html">Query.OrderByClause</a></li>
	                            <li><a href="../classes/QueryObject.html">QueryObject</a></li>
	                            <li><a href="../classes/SimplePredicate.html">SimplePredicate</a></li>
	                            <li><a href="../classes/Store.html">Store</a></li>
	                            <li><a href="../classes/StoreMixin.html">StoreMixin</a></li>
	                            <li><a href="../classes/StringPredicate.html">StringPredicate</a></li>
	                            <li><a href="../classes/Syncer.html">Syncer</a></li>
	                    </ul>
	                </div>
	    
	                <div class="tab-pane" id="modules">
	                    <ul id="api-modules" class="nav nav-list">
	                            <li><a href="../modules/ember-flexberry.html">ember-flexberry</a></li>
	                            <li><a href="../modules/ember-flexberry-data.html">ember-flexberry-data</a></li>
	                    </ul>
	                </div>
	            </div>
	        </div>
	    </div>
        </div>
        <div class="span9">
                <form id="options-form" class="form-inline pull-right">
                    Show:
                    <label for="api-show-inherited" class="checkbox">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected" class="checkbox">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private" class="checkbox">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated" class="checkbox">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </form>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<div class="page-header">
    <h1>addon/stores/local-store.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
/**
  @module ember-flexberry-data
*/

import { computed } from &#x27;@ember/object&#x27;;
import { getOwner } from &#x27;@ember/application&#x27;;
import { isArray } from &#x27;@ember/array&#x27;;
import { assert, debug } from &#x27;@ember/debug&#x27;;
import { isNone } from &#x27;@ember/utils&#x27;;
import RSVP from &#x27;rsvp&#x27;;
import DS from &#x27;ember-data&#x27;;
import OfflineAdapter from &#x27;../adapters/offline&#x27;;
import QueryBuilder from &#x27;../query/builder&#x27;;

/**
  Store that used in offline mode by default.

  @class LocalStore
  @extends &lt;a href=&quot;http://emberjs.com/api/data/classes/DS.Store.html&quot;&gt;DS.Store&lt;/a&gt;
  @private
*/
export default DS.Store.extend({
  /**
    Database name for IndexedDB.

    @property dbName
    @type String
    @default &#x27;ember-flexberry-data&#x27;
  */
  dbName: computed({
    get() {
      return this.get(&#x27;adapter.dbName&#x27;);
    },
    set(key, value) {
      return this.set(&#x27;adapter.dbName&#x27;, value);
    },
  }),

  /**
    Initializing instance.
    [More info](http://emberjs.com/api/data/classes/DS.Store.html#method_init).

    @method init
  */
  init() {
    this._super(...arguments);
    let dbName = this.get(&#x27;dbName&#x27;);
    let owner = getOwner(this);
    this.set(&#x27;adapter&#x27;, OfflineAdapter.create(owner.ownerInjection(), dbName ? { dbName } : {}));
  },

  /**
   * Returns an instance of the serializer for a given type.
   * Offline serializers should have name with postfix &#x27;-offline&#x27;.
   *
   * @method serializerFor
   * @param {String} modelName The name of the model type.
   * @public
   */
  serializerFor: function(modelName) {
    let owner = getOwner(this);
    let serializer = owner.lookup(&#x60;serializer:${modelName}-offline&#x60;);
    if (!serializer) {
      serializer = owner.lookup(&#x60;serializer:application-offline&#x60;);
      if (!serializer) {
        serializer = this.adapterFor(modelName).defaultSerializer;
      }
    }

    return serializer;
  },

  /**
   * Returns an instance of the adapter for a given type.
   * Offline adapters should have name with postfix &#x27;-offline&#x27;.
   *
   * @method adapterFor
   * @param {String} modelName The name of the model type.
   * @public
   */
  adapterFor: function(modelName) {
    let owner = getOwner(this);
    let adapter = owner.lookup(&#x60;adapter:${modelName}-offline&#x60;);
    if (!adapter) {
      adapter = owner.lookup(&#x60;adapter:application-offline&#x60;);
      if (!adapter) {
        adapter = this.get(&#x27;adapter&#x27;);
      }
    }

    return adapter;
  },

  /**
   * Finds the records for the given model type.
   *
   * See {{#crossLink &quot;DS.Store/findAll:method&quot;}}{{/crossLink}} for details.
   *
   * @method findAll
   * @public
   *
   * @param {String} modelName The name of the model type.
   * @param {Object} [options] Options.
   * @param {String} options.projection Projection name.
   * @return {DS.AdapterPopulatedRecordArray} Records promise.
   */
  findAll: function(modelName, options) {
    debug(&#x60;Flexberry Local Store::findAll ${modelName}&#x60;);

    let builder = new QueryBuilder(this, modelName);
    if (options &amp;&amp; options.projection) {
      debug(&#x60;Flexberry Local Store::findAll using projection &#x27;${options.projection}&#x27;&#x60;);

      builder.selectByProjection(options.projection);
      return this.query(modelName, builder.build());
    }

    let queryObject = builder.build();

    // Now if projection is not specified then only &#x27;id&#x27; field will be selected.
    queryObject.select = [];
    return this.query(modelName, queryObject);
  },

  /**
   * Returns a record for a given type and id combination.
   *
   * See {{#crossLink &quot;DS.Store/findRecord:method&quot;}}{{/crossLink}} for details.
   *
   * @method findRecord
   * @public
   *
   * @param {String} modelName The name of the model type.
   * @param {String|Integer} id Record ID.
   * @param {Object} [options] Options.
   * @param {String} options.projection Projection name.
   * @return {Promise} Record promise.
   */
  findRecord: function(modelName, id, options) {
    // TODO: case of options.reload === false.
    debug(&#x60;Flexberry Local Store::findRecord ${modelName}(${id})&#x60;);

    let builder = new QueryBuilder(this, modelName).byId(id);
    if (options &amp;&amp; options.projection) {
      debug(&#x60;Flexberry Local Store::findRecord using projection &#x27;${options.projection}&#x27;&#x60;);

      builder.selectByProjection(options.projection);
      return this.queryRecord(modelName, builder.build());
    }

    let queryObject = builder.build();

    // Now if projection is not specified then only &#x27;id&#x27; field will be selected.
    queryObject.select = [];
    return this.queryRecord(modelName, queryObject);
  },

  /**
   * This method delegates a query to the adapter.
   *
   * See {{#crossLink &quot;DS.Store/query:method&quot;}}{{/crossLink}} for details.
   *
   * @method query
   * @public
   *
   * @param {String} modelName The name of the model type.
   * @param {Object} query An opaque query to be used by the adapter.
   * @param {String} [query.projection] Projection name.
   * @return {Promise} A promise, which is resolved with a
   *                   {{#crossLink &quot;DS.RecordArray&quot;}}RecordArray{{/crossLink}}
   *                   once the server returns.
   */
  query: function(modelName, query) {
    debug(&#x60;Flexberry Local Store::query ${modelName}&#x60;, query);

    let promise = this._super(...arguments);
    return new RSVP.Promise((resolve, reject) =&gt; {
      promise.then((results) =&gt; {
        if (results &amp;&amp; isArray(results)) {
          results.forEach((result) =&gt; {
            result.didLoad();
          });
        }

        resolve(results);
      }, reject);
    });
  },

  /**
   * This method delegates a query to the adapter.
   *
   * See {{#crossLink &quot;DS.Store/queryRecord:method&quot;}}{{/crossLink}} for details.
   *
   * @method queryRecord
   * @public
   *
   * @param {String} modelName The name of the model type.
   * @param {Object} query An opaque query to be used by the adapter.
   * @param {String} [query.projection] Projection name.
   * @return {Promise} A promise, which is resolved with a
   *                   {{#crossLink &quot;DS.RecordObject&quot;}}RecordObject{{/crossLink}}
   *                   once the server returns.
   */
  queryRecord: function(modelName, query) {
    debug(&#x60;Flexberry Local Store::queryRecord ${modelName}&#x60;, query);

    let promise = this._super(...arguments);
    return new RSVP.Promise((resolve, reject) =&gt; {
      promise.then((result) =&gt; {
        if (result) {
          result.didLoad();
        }

        resolve(result);
      }, reject);
    });
  },

  /**
    Delete all record from the current store.
    @method deleteRecord
    @param {String} modelName modelName
    @param {Object} filter filter
  */
  deleteAllRecords: function(modelName, filter) {
    let adapter = this.adapterFor(modelName);
    if (isNone(adapter.deleteAllRecords)) {
      assert(&#x27;Method \&#x27;deleteAllRecords\&#x27; is missing&#x27;);
    }

    return adapter.deleteAllRecords(adapter.store, modelName, filter);
  },

  /**
    A method to send batch update, create or delete models in single transaction.

    It is recommended to create new models with identifiers, otherwise, after saving, the model object in the store will be created anew.

    The array which fulfilled the promise may contain the following values:
    - &#x60;new model object&#x60; - for records created without client id.
    - &#x60;same model object&#x60; - for created, updated or unaltered records.
    - &#x60;null&#x60; - for deleted records.

    @method batchUpdate
    @param {DS.Model[]|DS.Model} models Is array of models or single model for batch update.
    @return {Promise} A promise that fulfilled with an array of models in the new state.
  */
  batchUpdate(models) {
    return this.adapterFor(&#x27;application&#x27;).batchUpdate(this, models);
  },
});

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
